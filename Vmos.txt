import sys
import threading
import requests
import hashlib
import random
import time
import re
from colorama import init

init(autoreset=True)

# ANSI escape codes for text formatting
RESET = "\033[0m"
BOLD = "\033[1m"
GREEN_COLOR = "\033[32m"
RED_COLOR = "\033[31m"
YELLOW_COLOR = "\033[33m"
WHITE_COLOR = "\033[37m"

def md5_encode(input_string):
    md5_hash = hashlib.md5()
    md5_hash.update(input_string.encode('utf-8'))
    return md5_hash.hexdigest()

# TempMail.lol API Integration
def create_email_session():
    # Free tier uses random prefix if not specified
    url = "https://api.tempmail.lol/v2/inbox/create"
    response = requests.get(url)
    data = response.json()
    return data["address"], data["token"]

def check_received_emails(token, seen_mails):
    url = f"https://api.tempmail.lol/v2/inbox?token={token}"
    try:
        response = requests.get(url)
        response.raise_for_status()
        data = response.json()
        emails = data.get("emails", [])
        for email in emails:
            # Generate a unique ID for the email if not present
            mail_id = hashlib.md5((email['from'] + email['subject'] + str(email['date'])).encode()).hexdigest()
            if mail_id not in seen_mails:
                seen_mails.add(mail_id)
                body = email.get("body", "")
                six_digit_code = re.search(r'\b\d{6}\b', body)
                if six_digit_code:
                    return six_digit_code.group()
        return None
    except Exception as e:
        print(f"Error fetching emails: {str(e)}")
        return None

# VMOS API Functions
def send_sms(email):
    url = "https://api.vmoscloud.com/vcpcloud/api/sms/smsSend"
    headers = {"Content-Type": "application/json"}
    data = {
        "smsType": 2,
        "mobilePhone": email,
        "captchaVerifyParam": "{\"sceneId\":\"5jvar3wp\",\"certifyId\":\"2kUIqW7\"}"
    }
    response = requests.post(url, json=data, headers=headers)
    return 1 if response.status_code == 200 else 0

def login_account(email, verify_code, channel):
    url = "https://api.vmoscloud.com/vcpcloud/api/user/login"
    hashed_password = hashlib.md5(verify_code.encode()).hexdigest()
    data = {
        "mobilePhone": email,
        "loginType": 0,
        "verifyCode": verify_code,
        "password": hashed_password,
        "channel": "",
    }
    headers = {
        "Content-Type": "application/json",
        "SupplierType": "0",
        "Token": "jZIM7ryozuAJUvPqQQfVCi7YyatOZjvD",
        "appVersion": "1004000",
        "channel": channel,
        "clientType": "web",
        "requestsource": "wechat-miniapp",
    }
    response = requests.post(url, json=data, headers=headers)
    if response.status_code == 200:
        res = response.json()
        if res.get("code") == 200 and "data" in res:
            return res["data"].get("token"), res["data"].get("userId")
    return None, None

def login_to_vmoscloud(mobile_phone, password):
    url = "https://api.vmoscloud.com/vcpcloud/api/user/login"
    data = {
        "mobilePhone": mobile_phone,
        "password": md5_encode(password),
        "loginType": 1,
        "channel": "web"
    }
    headers = {"Content-Type": "application/json", "appVersion": "1004000", "clientType": "web"}
    response = requests.post(url, json=data, headers=headers)
    if response.status_code == 200:
        res = response.json()
        if res.get("code") == 200 and "data" in res:
            return res["data"].get("token"), res["data"].get("userId")
    return None, None

def get_equipment_info(token):
    url = "https://api.vmoscloud.com/vcpcloud/api/userEquipment/list?supplierType=-1&queryAuthorizedEquipments=true"
    headers = {"Content-Type": "application/json", "token": token, "appVersion": "1004000"}
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        res = response.json()
        if res.get("code") == 200 and "data" in res:
            print(f"{'Equipment ID':<15} | {'Pad Name':<20} | {'Time Left':<25}")
            print("-" * 65)
            for equip in res["data"]:
                for pad in equip["userPads"]:
                    eid = pad.get("equipmentId", "N/A")
                    name = pad.get("padName", "N/A")
                    expiry = pad.get("signExpirationTimeTamp")
                    ts = res.get("ts")
                    if expiry and ts:
                        diff = expiry - ts
                        d = diff // (1000*60*60*24)
                        h = (diff // (1000*60*60)) % 24
                        m = (diff // (1000*60)) % 60
                        time_str = f"{d}d {h}h {m}m"
                    else: time_str = "N/A"
                    print(f"{eid:<15} | {name:<20} | {time_str:<25}")

def transfer_device(token, to_email, verify_code, equipment_ids):
    url = "https://api.vmoscloud.com/vcpcloud/api/userEquipment/makeOverEquipments"
    payload = {"makeOverMobilePhone": to_email, "verifyCode": verify_code, "equipmentIds": equipment_ids, "type": 0}
    headers = {"Content-Type": "application/json", "token": token, "clienttype": "web", "appversion": "1004000"}
    response = requests.post(url, json=payload, headers=headers)
    return 1 if response.status_code == 200 else 0

def add_time(token, equipment_id, user_id):
    url = "https://api.vmoscloud.com/vcpcloud/api/agentRewardDurationExchange/durationExchange"
    headers = {"Content-Type": "application/json", "token": token, "userid": str(user_id), "appversion": "1004000"}
    payload = {"duration": 540, "equipmentId": equipment_id}
    response = requests.post(url, headers=headers, json=payload)
    if response.status_code == 200:
        print(f"{BOLD}{GREEN_COLOR}âœ… Success Device +9H{RESET}")
        return response.json()
    return None

def send_sms_transfer(token, user_id, mobile_phone):
    url = "https://api.vmoscloud.com/vcpcloud/api/sms/smsSend"
    headers = {"Content-Type": "application/json", "Token": token, "userId": str(user_id), "appVersion": "1004000"}
    data = {"smsType": 7, "mobilePhone": mobile_phone}
    response = requests.post(url, json=data, headers=headers)
    return 1 if response.status_code == 200 else 0

def send_sms_verify_channel(token, user_id, email):
    url = "https://api.vmoscloud.com/vcpcloud/api/sms/smsSend"
    headers = {"Content-Type": "application/json", "Token": token, "userId": str(user_id), "appVersion": "1004000"}
    data = {"smsType": 13, "mobilePhone": email}
    response = requests.post(url, json=data, headers=headers)
    return 1 if response.status_code == 200 else 0

def agent_verify(token, user_id, email, verifyCode):
    url = "https://api.vmoscloud.com/vcpcloud/api/agentUser/saveAgentUserInvite"
    headers = {"Content-Type": "application/json", "Token": token, "userId": str(user_id), "appVersion": "1004000"}
    data = {"verifyCode": verifyCode}
    response = requests.post(url, json=data, headers=headers)
    return response.json() if response.status_code == 200 else None

def get_channel_code(token, user_id, email, tempmail_token, seen_mails):
    while send_sms_verify_channel(token, user_id, email) == 0:
        time.sleep(1)
    time.sleep(5)
    code = None
    while not code:
        code = check_received_emails(tempmail_token, seen_mails)
        time.sleep(2)
    res = agent_verify(token, user_id, email, code)
    if res and res.get('data'):
        return res['data'].get('channelCode')
    return None

def buy_trial_phone(token):
    url = "https://api.vmoscloud.com/vcpcloud/api/userEquipment/buyTrialPhone"
    headers = {
        "Content-Type": "application/json",
        "token": token,
        "appVersion": "1004000",
        "clientType": "web"
    }
    # Thá»­ nghiá»‡m vá»›i payload rá»—ng hoáº·c thÃ´ng sá»‘ máº·c Ä‘á»‹nh náº¿u cáº§n
    payload = {} 
    try:
        response = requests.post(url, json=payload, headers=headers)
        if response.status_code == 200:
            res = response.json()
            if res.get("code") == 200:
                print(f"{BOLD}{GREEN_COLOR}âœ… Successfully bought trial phone!{RESET}")
                return True
            else:
                print(f"{BOLD}{RED_COLOR}âŒ Failed to buy trial phone: {res.get('msg')}{RESET}")
        else:
            print(f"{BOLD}{RED_COLOR}âŒ HTTP Error buying trial phone: {response.status_code}{RESET}")
    except Exception as e:
        print(f"{BOLD}{RED_COLOR}â›”ï¸ Exception buying trial phone: {str(e)}{RESET}")
    return False

def process_account(seen_mails, accounts, channel, buy_trial=False):
    try:
        email, token = create_email_session()
        while send_sms(email) == 0:
            time.sleep(1)
        code = None
        while not code:
            code = check_received_emails(token, seen_mails)
            time.sleep(2)
        login_token, user_id = login_account(email, code, channel)
        if login_token and user_id:
            if buy_trial:
                buy_trial_phone(login_token)
            accounts.append((email, code, login_token, user_id, token))
    except Exception as e:
        print(f"{BOLD}{RED_COLOR}â›”ï¸ Exception: {str(e)}{RESET}")

def main():
    print(f"{BOLD}{YELLOW_COLOR}--- VMOS Cloud Automation Tool ---{RESET}")
    mode = input("Choose mode (1: Buff Time, 2: Reg Account + Buy Trial): ")
    
    if mode == "2":
        count = int(input("Enter number of accounts to create: "))
        seen_mails = set()
        accounts = []
        threads = []
        for _ in range(count):
            time.sleep(0.3)
            t = threading.Thread(target=process_account, args=(seen_mails, accounts, "", True))
            threads.append(t)
            t.start()
        for t in threads: t.join()
        print(f"\n{BOLD}{GREEN_COLOR}Finished creating {len(accounts)} accounts with trial phones.{RESET}")
        return

    mobile_phone = input("âœ’ï¸ Enter email address: ")
    password = input("âœ’ï¸ Enter password: ")
    login_token_main, user_id_main = login_to_vmoscloud(mobile_phone, password)
    if not login_token_main:
        print("Login failed.")
        return
    
    print(f"{BOLD}{GREEN_COLOR}Token: {YELLOW_COLOR}{login_token_main} | User ID: {YELLOW_COLOR}{user_id_main}{RESET}")
    get_equipment_info(login_token_main)
    
    seen_mails = set()
    accounts1 = []
    
    try:
        count = int(input(f"{BOLD}âœ’ï¸ Enter number of host accounts (1-25):{RESET} "))
    except:
        count = 10
    
    print(f"{BOLD}{GREEN_COLOR}\nâœ… Generating emails using TempMail.lol{RESET}")
    threads = []
    for _ in range(count):
        time.sleep(0.3)
        t = threading.Thread(target=process_account, args=(seen_mails, accounts1, ""))
        threads.append(t)
        t.start()
    for t in threads: t.join()

    print("\nHost accounts list")
    for email, pwd, tok, uid, mail_tok in accounts1:
        print(f"{BOLD}{GREEN_COLOR}Added: {YELLOW_COLOR}{email} | {uid}{RESET}")
        
    equipment_id = input(f"{BOLD}âœ’ï¸ Enter device id to buff:{RESET} ")
    while send_sms_transfer(login_token_main, user_id_main, mobile_phone) == 0:
        time.sleep(1)
    
    google_verify_code = input(f"{BOLD}ðŸ“© Enter verify code from your email:{RESET} ")
    equipment_ids = [int(equipment_id)]
    
    print(f"{BOLD}{GREEN_COLOR}\nâŒ› Transferring to host 1...{RESET}")
    if transfer_device(login_token_main, accounts1[0][0], google_verify_code, equipment_ids) == 1:
        print(f"{BOLD}{GREEN_COLOR}Transfer Complete!{RESET}")
    else:
        print(f"{BOLD}{RED_COLOR}Transfer Failed!{RESET}")
        return
        
    sumTime = 0
    for idx, (email, pwd, tok, uid, mail_tok) in enumerate(accounts1):
        channel_code = get_channel_code(tok, uid, email, mail_tok, seen_mails)
        accounts2 = []
        threads2 = []
        for _ in range(12):
            t = threading.Thread(target=process_account, args=(seen_mails, accounts2, channel_code or ""))
            threads2.append(t)
            t.start()
        for t in threads2: t.join()
            
        for _ in range(4):
            add_time(tok, equipment_id, uid)
            sumTime += 9
        
        while send_sms_transfer(tok, uid, email) == 0:
            time.sleep(1)
        verify_code = None
        while not verify_code:
            verify_code = check_received_emails(mail_tok, seen_mails)
            time.sleep(2)
        
        if idx + 1 == count:
            print(f"{BOLD}{GREEN_COLOR}\nTOTAL TIME BUFF {sumTime}{RESET}")
            transfer_device(tok, mobile_phone, verify_code, equipment_ids)
            print(f"{BOLD}{GREEN_COLOR}âœ… Complete!{RESET}")
        else:
            print(f"{BOLD}{GREEN_COLOR}\nâŒ› Transferring to host {idx+2}/{count}...{RESET}")
            transfer_device(tok, accounts1[idx+1][0], verify_code, equipment_ids)

if __name__ == "__main__":
    main()
